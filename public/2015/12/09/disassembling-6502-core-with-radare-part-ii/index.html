<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Disassembling 6502 code with Radare - Part II | RETRO.MOE</title>
<meta name="keywords" content="">
<meta name="description" content="Let&rsquo;s crack a simple game.¬†If you are not familiar with Radare, read Part I first.
Creating and opening a VICE Snapshot file
Let&rsquo;s crack BC&rsquo;s Quest For Tires since its copy-protection is easy to bypass.


Unzip this file:¬†http://tapes.c64.no/tapes/BCsQuestForTires.zip


Open the tap file with VICE¬†(the most popular Commodore 64 emulator), and..


&hellip;the game has some kind of copy-protection. If we enter invalid codes, we won&rsquo;t be able to play the game.


Since Radare supports VICE Snapshot File format, we can save an snapshot of the game, and analyze¬†it with Radare.

In VICE, go to the menu, Snapshot -&gt; Save Snapshot Image&hellip;

If we¬†select &ldquo;Save ROMs&rdquo;, then the BASIC ROM and the KERNAL ROM will be saved inside the Snapshot file, and will be included as Radare sections.




Radare VICE Snapshot File (VSF) support lets us inspect:

The 64k RAM of the computer at the moment the snapshot was saved
The BASIC and KERNAL ROMs in case they were saved.

To open a VSF file, just¬†pass the VSF file as the first argument:
$ r2 bc_copy_protection_screen.vsf
[0x00005689]&gt;
0x00005689 is the PC (program counter) at the moment¬†the snapshot was saved.
">
<meta name="author" content="ricardoquesada">
<link rel="canonical" href="http://localhost:1313/2015/12/09/disassembling-6502-core-with-radare-part-ii/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fcb3718b9739f6b39cc36096f68dccc8a7e0d3e24fc6b09c575e0c25ec8f35b2.css" integrity="sha256-/LNxi5c59rOcw2CW9o3MyKfg0&#43;JPxrCcV14MJeyPNbI=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/2015/12/09/disassembling-6502-core-with-radare-part-ii/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">

</head>

<body class="" id="top">
<script>
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="RETRO.MOE (Alt + H)">RETRO.MOE</a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/unijoysticle/" title="Unijoysticle‚Ñ¢">
                    <span>Unijoysticle‚Ñ¢</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/unijoysticle2/" title="Unijoysticle‚Ñ¢ 2">
                    <span>Unijoysticle‚Ñ¢ 2</span>
                </a>
            </li>
            <li>
                <a href="https://www.tindie.com/stores/riq/" title="Store">
                    <span>Store</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/contact/" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="üîç">
                    <span>üîç</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;¬ª&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Disassembling 6502 code with Radare - Part II
    </h1>
    <div class="post-meta"><span title='2015-12-10 02:54:47 +0000 +0000'>December 10, 2015</span>&nbsp;¬∑&nbsp;8 min&nbsp;¬∑&nbsp;ricardoquesada

</div>
  </header> 
  <div class="post-content"><p>Let&rsquo;s crack a simple game.¬†If you are not familiar with Radare, read <a href="/2015/11/18/disassembling-6502-code-with-radare-part-i/">Part I</a> first.</p>
<h3 id="creating-and-opening-a-vice-snapshot-file">Creating and opening a VICE Snapshot file<a hidden class="anchor" aria-hidden="true" href="#creating-and-opening-a-vice-snapshot-file">#</a></h3>
<p>Let&rsquo;s crack BC&rsquo;s Quest For Tires since its copy-protection is easy to bypass.</p>
<ul>
<li>Unzip this file:¬†<a href="http://tapes.c64.no/tapes/BCsQuestForTires.zip">http://tapes.c64.no/tapes/BCsQuestForTires.zip</a></li>
<li>Open the tap file with <a href="http://vice-emu.sourceforge.net/">VICE</a>¬†(the most popular Commodore 64 emulator), and..</li>
</ul>
<figure>
    <img loading="lazy" src="/wp-content/uploads/2015/12/screen-shot-2015-12-09-at-3-03-39-pm.png?w=700" width="308"/> 
</figure>

<ul>
<li>&hellip;the game has some kind of copy-protection. If we enter invalid codes, we won&rsquo;t be able to play the game.</li>
</ul>
<p>Since Radare supports VICE Snapshot File format, we can save an snapshot of the game, and analyze¬†it with Radare.</p>
<ul>
<li>In VICE, go to the menu, Snapshot -&gt; Save Snapshot Image&hellip;
<ul>
<li>If we¬†select &ldquo;Save ROMs&rdquo;, then the BASIC ROM and the KERNAL ROM will be saved inside the Snapshot file, and will be included as Radare sections.</li>
</ul>
</li>
</ul>
<p><a href="/wp-content/uploads/2015/12/save_snapshot_dialog.png"><img alt="save_snapshot_dialog" loading="lazy" src="/wp-content/uploads/2015/12/save_snapshot_dialog.png?w=700"></a></p>
<p>Radare VICE Snapshot File (VSF) support lets us inspect:</p>
<ul>
<li>The 64k RAM of the computer at the moment the snapshot was saved</li>
<li>The BASIC and KERNAL ROMs in case they were saved.</li>
</ul>
<p>To open a VSF file, just¬†pass the VSF file as the first argument:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ r2 bc_copy_protection_screen.vsf
</span></span><span style="display:flex;"><span>[0x00005689]&gt;
</span></span></code></pre></div><p><code>0x00005689</code> is the PC (program counter) at the moment¬†the snapshot was saved.</p>
<h3 id="radare-sections">Radare Sections<a hidden class="anchor" aria-hidden="true" href="#radare-sections">#</a></h3>
<p>With the command <code>S</code> we can inspect the <code>S</code> ections of the VSF file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[0x00005689]&gt; S
</span></span><span style="display:flex;"><span>[00] . 0x0001209d mr-x va=0xa000 sz=0x2000 vsz=0x2000 BASIC
</span></span><span style="display:flex;"><span>[01] . 0x0001009d mr-x va=0xe000 sz=0x2000 vsz=0x2000 KERNAL
</span></span><span style="display:flex;"><span>[02] * 0x00000084 mrwx va=0x0000 sz=0x10000 vsz=0x10000 RAM
</span></span></code></pre></div><p>With <code>S=</code>, we see the sections in a more visual way.</p>
<p><a href="/wp-content/uploads/2015/12/screen-shot-2015-12-09-at-3-41-46-pm.png"><img alt="Radare S= command" loading="lazy" src="/wp-content/uploads/2015/12/screen-shot-2015-12-09-at-3-41-46-pm.png?w=700"></a></p>
<p>As we can see:</p>
<ul>
<li>BASIC starts at <code>0xa000</code> and it takes 8k</li>
<li>KERNAL starts at <code>0xe000</code> and it takes 8k</li>
<li>RAM starts at <code>0x0000</code>, and takes 64k</li>
</ul>
<p>Let&rsquo;s disassemble the KERNAL reset routine, the one at 64738:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[0x0000fce2]&gt; s 64738
</span></span><span style="display:flex;"><span>[0x0000fce2]&gt; pd 14
</span></span><span style="display:flex;"><span>            0xfce2      a2ff           ldx #0xff
</span></span><span style="display:flex;"><span>            0xfce4      78             sei
</span></span><span style="display:flex;"><span>            0xfce5      9a             txs
</span></span><span style="display:flex;"><span>            0xfce6      d8             cld
</span></span><span style="display:flex;"><span>            0xfce7      2002fd         jsr 0xfd02
</span></span><span style="display:flex;"><span>        ‚îå‚îÄ&lt; 0xfcea      d003           bne 0x03
</span></span><span style="display:flex;"><span>        ‚îÇ   0xfcec      6c0080         jmp (0x8000)
</span></span><span style="display:flex;"><span>        ‚îî‚îÄ&gt; 0xfcef      8e16d0         stx sym.VIC_CTRL2
</span></span><span style="display:flex;"><span>            0xfcf2      20a3fd         jsr 0xfda3
</span></span><span style="display:flex;"><span>            0xfcf5      2050fd         jsr 0xfd50
</span></span><span style="display:flex;"><span>            0xfcf8      2015fd         jsr 0xfd15
</span></span><span style="display:flex;"><span>            0xfcfb      205bff         jsr 0xff5b
</span></span><span style="display:flex;"><span>            0xfcfe      58             cli
</span></span><span style="display:flex;"><span>            0xfcff      6c00a0         jmp (0xa000)
</span></span></code></pre></div><p>Actually we are not interested in disassembling the KERNAL at this moment, but we should know it is possible to do it. In case we want to disassemble the memory RAM that is beneath the KERNAL and/or BASIC we should remove the KERNAL¬†and/or BASIC¬†sections. We can add them again if needed.
Use the <code>S-</code> command to remove Sections:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>0x0000fce2]&gt; S
</span></span><span style="display:flex;"><span>[00] . 0x0001209d mr-x va=0xa000 sz=0x2000 vsz=0x2000 BASIC
</span></span><span style="display:flex;"><span>[01] * 0x0001009d mr-x va=0xe000 sz=0x2000 vsz=0x2000 KERNAL
</span></span><span style="display:flex;"><span>[02] . 0x00000084 mrwx va=0x0000 sz=0x10000 vsz=0x10000 RAM
</span></span><span style="display:flex;"><span>[0x0000fce2]&gt; S-0
</span></span><span style="display:flex;"><span>[0x0000fce2]&gt; S-0
</span></span><span style="display:flex;"><span>[0x0000fce2]&gt; S
</span></span><span style="display:flex;"><span>[00] * 0x0001009d mr-x va=0xe000 sz=0x2000 vsz=0x2000 KERNAL
</span></span></code></pre></div><p>And¬†taking a look again at 64738 we find &ldquo;nothing&rdquo;, just &ldquo;empty&rdquo; RAM, which was expected:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[0x0000fce2]&gt; pd 14
</span></span><span style="display:flex;"><span> 0x0000fce2 ffffff isb 0xffff,x
</span></span><span style="display:flex;"><span> 0x0000fce5 ffffff isb 0xffff,x
</span></span><span style="display:flex;"><span> 0x0000fce8 ffffff isb 0xffff,x
</span></span><span style="display:flex;"><span> 0x0000fceb ffffff isb 0xffff,x
</span></span><span style="display:flex;"><span> 0x0000fcee ffffff isb 0xffff,x
</span></span><span style="display:flex;"><span> 0x0000fcf1 ffffff isb 0xffff,x
</span></span><span style="display:flex;"><span> 0x0000fcf4 ffffff isb 0xffff,x
</span></span><span style="display:flex;"><span> 0x0000fcf7 ffffff isb 0xffff,x
</span></span><span style="display:flex;"><span> 0x0000fcfa ffffff isb 0xffff,x
</span></span><span style="display:flex;"><span> 0x0000fcfd ffffff isb 0xffff,x
</span></span></code></pre></div><p>Remember that by appending <code>?</code> to any command, we can get help. In this case, <code>S?</code> will display the help for the <code>S</code> command.</p>
<h3 id="symbols-in-radare">Symbols in Radare<a hidden class="anchor" aria-hidden="true" href="#symbols-in-radare">#</a></h3>
<p>By doing a quick analysis of the snapshot, we can safely assume that the boot routine¬†starts¬†at <code>0x5500</code>. So, let&rsquo;s disassemble that address, and let&rsquo;s see what we find:</p>
<figure>
    <img loading="lazy" src="/wp-content/uploads/2015/12/radare%5Fsymbols.png?w=700" width="375"/> 
</figure>

<p>Radare will automatically import all the well-known symbols for the SID, VIC and CIA addresses. The symbols are imported in the symbols &ldquo;flag space&rdquo;. In order to display all the imported symbols, we¬†should do:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[0x00005689]&gt; fs
</span></span><span style="display:flex;"><span>0 0 . strings
</span></span><span style="display:flex;"><span>1 101 . symbols
</span></span><span style="display:flex;"><span>2 6 . sections
</span></span><span style="display:flex;"><span>[0x00005689]&gt; fs symbols
</span></span><span style="display:flex;"><span>[0x00005689]&gt; f
</span></span><span style="display:flex;"><span>0x00005689 1 entry0
</span></span><span style="display:flex;"><span>0x0000d000 2 sym.VIC_SPR0_X
</span></span><span style="display:flex;"><span>0x0000d001 2 sym.VIC_SPR0_Y
</span></span><span style="display:flex;"><span>0x0000d002 2 sym.VIC_SPR1_X
</span></span><span style="display:flex;"><span>0x0000d003 2 sym.VIC_SPR1_Y
</span></span><span style="display:flex;"><span>0x0000d004 2 sym.VIC_SPR2_X
</span></span><span style="display:flex;"><span>0x0000d005 2 sym.VIC_SPR2_Y
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><ul>
<li><code>fs</code>: displays all the available &ldquo;flag spaces&rdquo;</li>
<li><code>fs name</code>: switches to the selected &ldquo;flag space&rdquo;</li>
<li><code>f</code>: displays all the &ldquo;flags&rdquo; available in the selected &ldquo;space&rdquo;</li>
</ul>
<p>We¬†can also grep for certain symbols. Let&rsquo;s say that we want to know what are the CIA symbols.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[0x00005689]&gt; f~CIA
</span></span><span style="display:flex;"><span>0x0000dc00 2 sym.CIA1_PRA
</span></span><span style="display:flex;"><span>0x0000dc01 2 sym.CIA1_PRB
</span></span><span style="display:flex;"><span>0x0000dc02 2 sym.CIA1_DDRA
</span></span><span style="display:flex;"><span>0x0000dc03 2 sym.CIA1_DDRB
</span></span><span style="display:flex;"><span>0x0000dc08 2 sym.CIA1_TOD10
</span></span><span style="display:flex;"><span>0x0000dc09 2 sym.CIA1_TODSEC
</span></span><span style="display:flex;"><span>0x0000dc0a 2 sym.CIA1_TODMIN
</span></span><span style="display:flex;"><span>0x0000dc0b 2 sym.CIA1_TODHR
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Almost every command in Radare supports the <code>~</code> suffix which basically sends¬†the output to grep (like pipes in Unix).</p>
<p>If we¬†prefer raw¬†addresses, we¬†can just remove all the imported¬†symbols by doing:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[0x00005689]&gt; f-sym.*
</span></span></code></pre></div><p>And just remember that by appending¬†<code>?</code>, we¬†can see the help for the <code>f</code> command, in this case:¬†<code>f?</code>.</p>
<h3 id="radare-variables">Radare Variables<a hidden class="anchor" aria-hidden="true" href="#radare-variables">#</a></h3>
<p>So, after analyzing the boot code for a while we will realize¬†that the <code>0x6000</code> looks suspicious, and it could be the address that we are¬†looking for.¬† So, let&rsquo;s figure out is who calling¬†<code>0x6000</code>.</p>
<p>As we have seen in <a href="/2015/11/18/disassembling-6502-code-with-radare-part-i/">Part I</a>, we can use <code>/c</code> or <code>/x</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[0x00005500]&gt; /c jmp 0x6000
</span></span><span style="display:flex;"><span>0x000056ea # 3: jmp 0x6000
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[0x00005500]&gt; /x 4c0060
</span></span><span style="display:flex;"><span>Searching 3 bytes...
</span></span><span style="display:flex;"><span># 7 [0x5500-0x10000]
</span></span><span style="display:flex;"><span>hits: 1
</span></span><span style="display:flex;"><span>0x000056ea hit1_0 4c0060
</span></span></code></pre></div><p>One thing that we didn&rsquo;t know is that we can tell Radare to automatically perform a command for all the &ldquo;hits&rdquo; found by editing the <code>cmd.hit</code> variable. For example, in order to disassemble the first 5 instructions automatically after each &ldquo;hit&rdquo;, we should do:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[0x00005500]&gt; e cmd.hit = pd 5
</span></span><span style="display:flex;"><span>[0x00005500]&gt; /x 4c0060
</span></span><span style="display:flex;"><span>Searching 3 bytes...
</span></span><span style="display:flex;"><span># 7 [0x5500-0x10000]
</span></span><span style="display:flex;"><span>hits: 1
</span></span><span style="display:flex;"><span>0x000056ea hit3_0 4c0060
</span></span><span style="display:flex;"><span>            ;-- hit3_0:
</span></span><span style="display:flex;"><span>        ‚îå‚îÄ&lt; 0x000056ea      4c0060         jmp 0x6000
</span></span><span style="display:flex;"><span>        ‚îÇ   0x000056ed      20f856         jsr 0x56f8
</span></span><span style="display:flex;"><span>        ‚îÇ   0x000056f0      c8             iny
</span></span><span style="display:flex;"><span>        ‚îÇ   0x000056f1      20f856         jsr 0x56f8
</span></span><span style="display:flex;"><span>        ‚îÇ   0x000056f4      c8             iny
</span></span></code></pre></div><p>Radare has many built-in variables that can be changed with the <code>e</code> command. To display all the available variables, just type <code>e</code>. You can grep certain variables by using the <code>~</code> suffix.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[0x00005500]&gt; e
</span></span><span style="display:flex;"><span>anal.a2f = false
</span></span><span style="display:flex;"><span>anal.afterjmp = false
</span></span><span style="display:flex;"><span>anal.arch = 6502
</span></span><span style="display:flex;"><span>anal.bbsplit = true
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>[0x00005500]&gt; e~search
</span></span><span style="display:flex;"><span>anal.searchstringrefs = false
</span></span><span style="display:flex;"><span>search.align = 0
</span></span><span style="display:flex;"><span>search.chunk = 0
</span></span><span style="display:flex;"><span>search.contiguous = true
</span></span><span style="display:flex;"><span>search.count = 0
</span></span><span style="display:flex;"><span>search.distance = 0
</span></span><span style="display:flex;"><span>search.esilcombo = 8
</span></span><span style="display:flex;"><span>search.flags = true
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Some variables support the <code>?</code>¬†argument. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[0x00005500]&gt; e search.in=?
</span></span><span style="display:flex;"><span>raw
</span></span><span style="display:flex;"><span>block
</span></span><span style="display:flex;"><span>file
</span></span><span style="display:flex;"><span>io.maps
</span></span><span style="display:flex;"><span>io.maprange
</span></span><span style="display:flex;"><span>io.section
</span></span><span style="display:flex;"><span>io.sections
</span></span><span style="display:flex;"><span>io.sections.write
</span></span><span style="display:flex;"><span>io.sections.exec
</span></span><span style="display:flex;"><span>dbg.stack
</span></span><span style="display:flex;"><span>dbg.heap
</span></span><span style="display:flex;"><span>dbg.map
</span></span><span style="display:flex;"><span>dbg.maps
</span></span><span style="display:flex;"><span>dbg.maps.exec
</span></span><span style="display:flex;"><span>dbg.maps.write
</span></span><span style="display:flex;"><span>anal.fcn
</span></span><span style="display:flex;"><span>anal.bb
</span></span></code></pre></div><p>The default option for <code>search.in</code> is <code>file</code>, which works Ok for us. But in some advance cases we might want to switch to either <code>io.sections</code> or <code>io.section</code>. More on this in future posts.</p>
<h3 id="cross-references">Cross references<a hidden class="anchor" aria-hidden="true" href="#cross-references">#</a></h3>
<p>Actually the easiest way to find who is calling a certain function is to use cross references (xrefs). Just tell Radare to analyze the binary with <code>aa</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[0x00005500]&gt; aa
</span></span></code></pre></div><p>And then disassemble <code>0x6000</code>¬†in Visual mode. While in¬†Visual mode we can use the following shortcuts to navigate the¬†xrefs:</p>
<ul>
<li><code>x</code>: To open¬†the &ldquo;Goto xrefs&rdquo; menu. It will appear at the top-left corner. Only available when we¬†see a XREF legend above a function.</li>
<li>Use <code>0-9</code> to jump to the displayed xrefs.</li>
</ul>
<p>Let&rsquo;s see how to do it:</p>
<p><a href="https://asciinema.org/a/31539?t=5"><img loading="lazy" src="https://asciinema.org/a/31539.png"></a></p>
<h3 id="modifying-the-game">Modifying the game<a hidden class="anchor" aria-hidden="true" href="#modifying-the-game">#</a></h3>
<p>First of all, in order to be able to modify and save a VSF file, we should start Radare with the <code>-w</code> argument. Example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ r2 -w bc_copy_protection_screen.vsf
</span></span></code></pre></div><p>Now, let&rsquo;s patch the game. After following the xrefs, we found that this is the code that jumps to <code>0x6000</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>‚îÇ       ‚îÇ   0x56c8      c502           cmp 0x02
</span></span><span style="display:flex;"><span>‚îÇ      ‚îå‚îÄ‚îÄ&lt; 0x56ca      d003           bne 0x03
</span></span><span style="display:flex;"><span>‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ&lt; 0x56cc      4cea56         jmp 0x56ea
</span></span><span style="display:flex;"><span>‚îÇ     ‚îÇ‚îî‚îÄ‚îÄ&gt; 0x56cf      ad4f57         lda 0x574f
</span></span></code></pre></div><p>One quick way to cheat the copy-protection is by replacing the <code>bne 0x03</code> with two¬†<code>nop</code> s.</p>
<p>The way to do it is by:</p>
<ol>
<li>Enter in Cursor mode (by pressing <code>c</code>)</li>
<li>Position the cursor in the <code>d003</code> values (from <code>bne 0x03</code>)</li>
<li>Once the cursor is there,¬†enter into Insert mode (by pressing <code>i</code>)</li>
<li>Then type <code>eaea</code> (two <code>nop</code> s) and then <code>enter</code></li>
<li>Then <code>q</code> to quit</li>
</ol>
<p>Example:
<a href="https://asciinema.org/a/31541"><img loading="lazy" src="https://asciinema.org/a/31541.png"></a></p>
<h3 id="reloading-the-vsf-file-in-vice">Reloading the VSF file in VICE<a hidden class="anchor" aria-hidden="true" href="#reloading-the-vsf-file-in-vice">#</a></h3>
<p>So, we have just patched the VSF file. If you load it from VICE, the game will be patched and we will be able to play the game, even if we enter invalid color codes.</p>
<p>Just open VICE -&gt; Menu -&gt; Snapshots -&gt; Load Snapshot Image&hellip;</p>
<p>And when the game asks you to enter the color codes, just enter any code, and you should see the game screen:</p>
<p><a href="/wp-content/uploads/2015/12/screen-shot-2015-12-09-at-6-26-18-pm.png"><img alt="Screen Shot 2015-12-09 at 6.26.18 PM" loading="lazy" src="/wp-content/uploads/2015/12/screen-shot-2015-12-09-at-6-26-18-pm.png?w=700"></a></p>
<h3 id="additional-notes">Additional notes<a hidden class="anchor" aria-hidden="true" href="#additional-notes">#</a></h3>
<ul>
<li>Radare also supports Commodore 128 VSF. If saved with ROMs, it will include the following sections:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[00] * 0x420a1 mr-x va=0x4000 sz=0x7000 vsz=0x7000 BASIC
</span></span><span style="display:flex;"><span>[01] . 0x490a1 mr-x va=0xb000 sz=0x1000 vsz=0x1000 MONITOR
</span></span><span style="display:flex;"><span>[02] . 0x4a0a1 mr-x va=0xc000 sz=0x1000 vsz=0x1000 EDITOR
</span></span><span style="display:flex;"><span>[03] . 0x400a1 mr-x va=0xe000 sz=0x2000 vsz=0x2000 KERNAL
</span></span><span style="display:flex;"><span>[04] . 0x0008c mrwx va=0x0000 sz=0x10000 vsz=0x10000 RAM_BANK_0
</span></span><span style="display:flex;"><span>[05] . 0x1008c mrwx va=0x0000 sz=0x10000 vsz=0x10000 RAM_BANK_1
</span></span></code></pre></div><ul>
<li>In order to save VSF files for C128, use a recent <a href="http://sourceforge.net/p/vice-emu/code/HEAD/tree/">VICE version from SVN</a>.</li>
<li>Radare VSF support was added a few days ago, so in order to use it, download <a href="https://github.com/radare/radare2">Radare from Github</a></li>
<li>VSF files are not meant to be &ldquo;distributable&rdquo; files. If you want to release a &ldquo;crack&rdquo; you should create .D64 or .PRG files. It is possible to create them from VSF files. More on this on future posts.</li>
</ul>
<h3 id="other-resources">Other resources<a hidden class="anchor" aria-hidden="true" href="#other-resources">#</a></h3>
<ul>
<li><a href="https://radare.gitbooks.io/radare2book/content/">Radare book</a></li>
<li>IRC:¬†<a href="http://irc.freenode.net/">irc.freenode.net</a> #radare</li>
<li>Twitter: <a href="https://twitter.com/radareorg">@radareorg</a></li>
<li><a href="/2015/11/18/disassembling-6502-code-with-radare-part-i/">Disassembling 6502 code with Radare - Part I</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>

<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Disassembling 6502 code with Radare - Part II on x"
            href="https://x.com/intent/tweet/?text=Disassembling%206502%20code%20with%20Radare%20-%20Part%20II&amp;url=http%3a%2f%2flocalhost%3a1313%2f2015%2f12%2f09%2fdisassembling-6502-core-with-radare-part-ii%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Disassembling 6502 code with Radare - Part II on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2f2015%2f12%2f09%2fdisassembling-6502-core-with-radare-part-ii%2f&amp;title=Disassembling%206502%20code%20with%20Radare%20-%20Part%20II&amp;summary=Disassembling%206502%20code%20with%20Radare%20-%20Part%20II&amp;source=http%3a%2f%2flocalhost%3a1313%2f2015%2f12%2f09%2fdisassembling-6502-core-with-radare-part-ii%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Disassembling 6502 code with Radare - Part II on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2f2015%2f12%2f09%2fdisassembling-6502-core-with-radare-part-ii%2f&title=Disassembling%206502%20code%20with%20Radare%20-%20Part%20II">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Disassembling 6502 code with Radare - Part II on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2f2015%2f12%2f09%2fdisassembling-6502-core-with-radare-part-ii%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Disassembling 6502 code with Radare - Part II on whatsapp"
            href="https://api.whatsapp.com/send?text=Disassembling%206502%20code%20with%20Radare%20-%20Part%20II%20-%20http%3a%2f%2flocalhost%3a1313%2f2015%2f12%2f09%2fdisassembling-6502-core-with-radare-part-ii%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Disassembling 6502 code with Radare - Part II on telegram"
            href="https://telegram.me/share/url?text=Disassembling%206502%20code%20with%20Radare%20-%20Part%20II&amp;url=http%3a%2f%2flocalhost%3a1313%2f2015%2f12%2f09%2fdisassembling-6502-core-with-radare-part-ii%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Disassembling 6502 code with Radare - Part II on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Disassembling%206502%20code%20with%20Radare%20-%20Part%20II&u=http%3a%2f%2flocalhost%3a1313%2f2015%2f12%2f09%2fdisassembling-6502-core-with-radare-part-ii%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>

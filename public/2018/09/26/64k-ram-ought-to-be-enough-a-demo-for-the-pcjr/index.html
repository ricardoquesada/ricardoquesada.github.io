<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>64K RAM Ought to be Enough: a demo for the PCjr | RETRO.MOE</title>
<meta name="keywords" content="">
<meta name="description" content="Updated 2018‚Äì10‚Äì08
https://www.youtube.com/watch?v=uakDpJns9LA
A demo for the IBM PCjr by Pungas de Villa Martelli. It was presented at Flashparty 2018 and won the Demo category.
Requirements
An IBM PCjr with at least 64k RAM.
Download

Source code:¬†https://gitlab.com/ricardoquesada/pcjr-flashparty‚Äì2018
Binary: pvm-64ko.zip (does not run on emulators)

Technical description
The demo is divided in the boot loader and demo 3 parts
Boot loader
[caption id=&quot;&quot; align=&ldquo;alignnone&rdquo; width=&ldquo;512&rdquo;] Boot loader[/caption]
The demo is intended to work with a 64K RAM (or more) PCjr. Booting from its own boot loader is needed to save precious memory. DOS alone takes ~20K of RAM. That is 30% of the total memory. You don‚Äôt want to waste that memory.
">
<meta name="author" content="ricardoquesada">
<link rel="canonical" href="http://localhost:1313/2018/09/26/64k-ram-ought-to-be-enough-a-demo-for-the-pcjr/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fcb3718b9739f6b39cc36096f68dccc8a7e0d3e24fc6b09c575e0c25ec8f35b2.css" integrity="sha256-/LNxi5c59rOcw2CW9o3MyKfg0&#43;JPxrCcV14MJeyPNbI=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/2018/09/26/64k-ram-ought-to-be-enough-a-demo-for-the-pcjr/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">

</head>

<body class="" id="top">
<script>
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="RETRO.MOE (Alt + H)">RETRO.MOE</a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/unijoysticle/" title="Unijoysticle‚Ñ¢">
                    <span>Unijoysticle‚Ñ¢</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/unijoysticle2/" title="Unijoysticle‚Ñ¢ 2">
                    <span>Unijoysticle‚Ñ¢ 2</span>
                </a>
            </li>
            <li>
                <a href="https://www.tindie.com/stores/riq/" title="Store">
                    <span>Store</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/contact/" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="üîç">
                    <span>üîç</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;¬ª&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      64K RAM Ought to be Enough: a demo for the PCjr
    </h1>
    <div class="post-meta"><span title='2018-09-27 06:25:17 +0000 +0000'>September 27, 2018</span>&nbsp;¬∑&nbsp;9 min&nbsp;¬∑&nbsp;ricardoquesada

</div>
  </header> 
  <div class="post-content"><p><em>Updated 2018‚Äì10‚Äì08</em></p>

    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="allowfullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/uakDpJns9LA?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"></iframe>
    </div>

<p>A demo for the IBM PCjr by <a href="http://pungas.space">Pungas de Villa Martelli</a>. It was presented at <a href="http://flashparty.dx.am/">Flashparty 2018</a> and <a href="http://flashparty.dx.am/index.php?option=com_content&amp;view=article&amp;id=37:results-fp-2018&amp;catid=2&amp;lang=en&amp;Itemid=134">won the Demo</a> category.</p>
<h2 id="requirements">Requirements<a hidden class="anchor" aria-hidden="true" href="#requirements">#</a></h2>
<p>An IBM PCjr with at least 64k RAM.</p>
<h2 id="download">Download<a hidden class="anchor" aria-hidden="true" href="#download">#</a></h2>
<ul>
<li>Source code:¬†<a href="https://gitlab.com/ricardoquesada/pcjr-flashparty-2018">https://gitlab.com/ricardoquesada/pcjr-flashparty‚Äì2018</a></li>
<li>Binary: <a href="http://pungas.space/pvm-64ko.zip">pvm-64ko.zip</a> (does not run on emulators)</li>
</ul>
<h1 id="technical-description">Technical description<a hidden class="anchor" aria-hidden="true" href="#technical-description">#</a></h1>
<p>The demo is divided in the boot loader and demo 3 parts</p>
<h2 id="boot-loader">Boot loader<a hidden class="anchor" aria-hidden="true" href="#boot-loader">#</a></h2>
<p>[caption id=&quot;&quot; align=&ldquo;alignnone&rdquo; width=&ldquo;512&rdquo;]<img alt="Boot loader" loading="lazy" src="https://lh3.googleusercontent.com/CAMqnjSjk-8f_gX2LvfrUq4QMQm8wgKtd-1Vhcmza4OcEiNYvKb7LJWMKNjcpUcaTUWXRfl8e6oz3bJcRXHTBdIjzTrELpX9eBGzYVSC9Rj4PsjbJqKBh0TfAoRnT-8JBFnNprd7xUs=-no"> Boot loader[/caption]
The demo is intended to work with a 64K RAM (or more) PCjr. Booting from its own boot loader is needed to save precious memory. DOS alone takes ~20K of RAM. That is 30% of the total memory. You don‚Äôt want to waste that memory.</p>
<p>The boot loader is pretty simple:</p>
<ul>
<li>
<p>It has a list of sectors-to-load for each part. Each part is loaded starting at <code>0050:0100</code>¬†address (which is the same as <code>0060:0000</code>) and after loading it, jumps to that address.</p>
</li>
<li>
<p>Installs <code>ricarDOS</code>, a mini ‚ÄúDOS‚Äù that hooks the <code>0x21</code> interrupt handler with:</p>
<ul>
<li>
<p><code>ah</code> == <code>0x4c</code>:</p>
<ul>
<li>in ricarDOS it terminates current scene and loads the next one.</li>
<li>in real DOS it terminates the current DOS program.</li>
</ul>
</li>
<li>
<p><code>ah</code> == <code>0x09</code>: prints a <code>$</code>-terminated string</p>
</li>
</ul>
</li>
</ul>
<p>ricarDOS was created to have a ‚Äúrapid testing framework‚Äù. It allows to run each part on an emulator using real DOS, but when run from the boot loader, the actual DOS calls are trapped to ricarDOS.</p>
<p>The memory is organized like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>Memory map:
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x01ff</span>: <span style="color:#ae81ff">512</span> bytes used <span style="color:#66d9ef">for</span> the vector table <span style="color:#66d9ef">for</span> the first <span style="color:#ae81ff">0x80</span> interrupts
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">0x0200</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x03ff</span>: <span style="color:#ae81ff">512</span> bytes used <span style="color:#66d9ef">for</span> ricarDOS
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">0x0400</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x04ff</span>: <span style="color:#ae81ff">256</span> bytes<span style="color:#f92672">.</span> BIOS variables
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">0x0500</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x05ff</span>: <span style="color:#ae81ff">256</span> bytes<span style="color:#f92672">.</span> stack<span style="color:#f92672">.</span> used globally <span style="color:#66d9ef">for</span> all the demo parts
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">0x0600</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xffff</span>: <span style="color:#ae81ff">64000</span> bytes free to be used <span style="color:#66d9ef">for</span> the demo (including video)
</span></span></code></pre></div><h2 id="part-i">Part I<a hidden class="anchor" aria-hidden="true" href="#part-i">#</a></h2>
<p><img alt="Graphic" loading="lazy" src="https://lh3.googleusercontent.com/AH1WrMv0WApGS6kK-9smYMGuEC8j8bcCwq1PWWMF69NmHBdM_L3KQGq5trnZN-1MLxKO2bKWIuM7MLH3eAn5wfx1r2Fj0b33pX3V1Z_RB3YXiEPH7eM_YBQqoU7dsXDA66UWdcy804E=-no"><img alt="Big fonts" loading="lazy" src="https://lh3.googleusercontent.com/lYLBVf8knEDl1izdoXc6zT2FEXv0P-2fCUQTBKw0NLal27L1j38zqyQ0XAPuabI54jN2SxnJP036vYILKvssxL9OLiQcxQN7GEbdIK0DMAmBoX__XoK9bMJbdv4R_jMrIgiavXfGMIk=-no"></p>
<h3 id="big-fonts">Big Fonts<a hidden class="anchor" aria-hidden="true" href="#big-fonts">#</a></h3>
<p>The big fonts are based on <a href="https://www.glassner.com/portfolio/andrew-glassners-notebook/">Andrew Glassner‚Äôs Notebook</a>. Basically the rectangle to draw each font is divided in 55 segments. Think of the typical 8-segment display, but instead of 8, it has 55 segments. With 55 segments you can render pretty nice fonts. Specially if they are designed by Andrew Glassner.</p>
<p>[caption id=&quot;&quot; align=&ldquo;alignnone&rdquo; width=&ldquo;386&rdquo;]<img alt="55 segments" loading="lazy" src="https://lh3.googleusercontent.com/79ypCtlpOuPHhS3RdXH1V_nHrbzYv9vFna60h_ribbU595KMMsaMokmi2jG7UVKSy3D874n2YMW0s7vQ3f-R8gOvO7q88p1PVZ38bUkgLNR9u9l8Nh1ipv4Se1GWlHi704TKYAAGjnY=-no"> 55 segments[/caption]
So we created 110 (55 + 55) primitives:</p>
<ul>
<li>55 primitives to turn on each segment</li>
<li>and 55 primitives to turn them off</li>
</ul>
<p>Each letter consists of a 64-bit bitset containing the 55 segments.</p>
<p>The bitset for letter <code>A</code> is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#75715e">;ASCII: 0x41
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>table_a:
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">dw</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">b1110010011101110</span>,<span style="color:#ae81ff">0</span><span style="color:#66d9ef">b1111111101000101</span>,<span style="color:#ae81ff">0</span><span style="color:#66d9ef">b1000111111111111</span>,<span style="color:#ae81ff">0</span><span style="color:#66d9ef">b0000000000000111</span>
</span></span></code></pre></div><p>And this one is for letter <code>B</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>;ASCII: 0x42
</span></span><span style="display:flex;"><span>table_b:
</span></span><span style="display:flex;"><span> dw 0b1010010011101111,0b0111111011111100,0b1111110001111111,0b0000000001111011
</span></span></code></pre></div><p>Notice that <code>A</code> and <code>B</code> have many segments in common. If letter <code>B</code> should be drawn right after letter <code>A</code>, then only the ‚Äúdiff‚Äù between <code>A</code> and <code>B</code> needs to be drawn.</p>
<p>[caption id=&quot;&quot; align=&ldquo;alignnone&rdquo; width=&ldquo;512&rdquo;]<img alt="A xor B" loading="lazy" src="https://lh3.googleusercontent.com/24yydo-E1AXNej4CzcHp8BDR_Z77aFOhKJcu7G8Tto8lyQm20FWnjOqtpPxIhXQeMj5JrzAtaHU6JX8SQh27vJ3OEnx_g0CJR03OC8kI-RomtGYWK_ZJmB9gx0J8ehbHAjEU21B-qbs=-no"> A xor B[/caption]</p>
<p>And the diff between <code>A</code> and <code>B</code> is just a simple <code>xor</code> between A‚Äôs bitset and B‚Äôs bitset.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>A: 0b1110010011101110,0b1111111101000101,0b1000111111111111,0b0000000000000111
</span></span><span style="display:flex;"><span> xor
</span></span><span style="display:flex;"><span>B: 0b1010010011101111,0b0111111011111100,0b1111110001111111,0b0000000001111011
</span></span><span style="display:flex;"><span> ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äì
</span></span><span style="display:flex;"><span> 0b0100000000000000,0b1000000110111001,0b0111001110000000,0b0000000001111000
</span></span></code></pre></div><p><code>0</code> are skipped (it means that the segemnts are the same), while <code>1</code> are processed. The segment is turned on or off accordingly. For <code>A xor B</code> only 18 segments needs to be updated, instead of 55.</p>
<p>And that‚Äôs it.</p>
<p><em>Misc:</em></p>
<ul>
<li><a href="https://aresluna.org/segmented-type/">Aresluna editor</a> was used to get the definition of each letter.</li>
<li>We used a custom script to automatically generate all the 110 primitives and bitsets.</li>
</ul>
<h3 id="graphic-loading">Graphic Loading<a hidden class="anchor" aria-hidden="true" href="#graphic-loading">#</a></h3>
<p>The Big Font uses the 320 x 200 @ 4 colors video mode. 16K RAM needed is needed for it. So, from the 64000 bytes reserved for the scene, 16k will be used for the video mode. That leaves 47616 bytes free for the code.</p>
<p>And the code to render the big fonts takes ~47000 bytes, with only a few hundred bytes free.</p>
<p>In order to add an additional 16K graphics, the new graphic was appended after the Big Font code (with some padding).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>part1.com format
</span></span><span style="display:flex;"><span>+--------------+  0x00600
</span></span><span style="display:flex;"><span>|              |
</span></span><span style="display:flex;"><span>| Big Font     |
</span></span><span style="display:flex;"><span>| code + data  |
</span></span><span style="display:flex;"><span>|              |
</span></span><span style="display:flex;"><span>|      |       |
</span></span><span style="display:flex;"><span>|      V       |
</span></span><span style="display:flex;"><span>|              |
</span></span><span style="display:flex;"><span>|  end of      |
</span></span><span style="display:flex;"><span>|  Big Font    |
</span></span><span style="display:flex;"><span>|~~~~~~~~~~~~~~|
</span></span><span style="display:flex;"><span>| padding...   | ~0x0bf00
</span></span><span style="display:flex;"><span>|~~~~~~~~~~~~~~|
</span></span><span style="display:flex;"><span>|              |  0x0c000
</span></span><span style="display:flex;"><span>| graphics     |
</span></span><span style="display:flex;"><span>| data         |
</span></span><span style="display:flex;"><span>| (16K RAM)    |
</span></span><span style="display:flex;"><span>|              |  0x0ffff
</span></span><span style="display:flex;"><span>+--------------+
</span></span></code></pre></div><p>So when the <code>part1.com</code> file is loaded, the graphic will be loaded right where the video card expects it. And it will be displayed automatically.</p>
<h2 id="part-ii">Part II<a hidden class="anchor" aria-hidden="true" href="#part-ii">#</a></h2>
<p>[caption id=&quot;&quot; align=&ldquo;alignnone&rdquo; width=&ldquo;512&rdquo;]<img alt="Graphic" loading="lazy" src="https://lh3.googleusercontent.com/4MW-iYFbMdc8y9M7Wqch8yMpWoV2M41gA-tZ2XtcQrkZgkdxxcm6YvBjFJjb9jKdktfIkMgsyONW98yjQpZ81lImrjYTJBBhkfhq1drlSg5OPeA_BXItkNvx_JTx25_K7IYxC0YBHHw=-no"> Part II: Using 320x200 @ 16[/caption]
From a technical point of view, nothing interesting really happens in Part II. It is just a simple horizontal scroll that consumes almost all the CPU cycles.</p>
<p><em>[Note: Additional effects were planned for this part, but we didn‚Äôt have the time]</em></p>
<p>It uses a 320x200 @ 16 colors video mode. In order to enable this video mode in a 64k-only PCjr you have to do:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sub   ax,ax
</span></span><span style="display:flex;"><span>mov   ds,ax              ;ds = 0
</span></span><span style="display:flex;"><span>mov   word [0x0415],128  ;make BIOS set_video_modo believe that we
</span></span><span style="display:flex;"><span>                         ; have at least 128K RAM, otherwise it won&#39;t let
</span></span><span style="display:flex;"><span>                         ; us set video mode 9
</span></span></code></pre></div><p><em><strong>Bug:</strong> the graphic won‚Äôt look that good on 64k-only PCjr. We tested this idea about 2 months before the deadline with a random graphic, and it looked Ok. So we though it was possible to use 32k video modes on the 64k-only PCjr. But one day before the release we noticed that the graphic didn‚Äôt look that good. And unfortunately we couldn‚Äôt fix it yet. Not sure whether this is a hardware limitation (it shouldn‚Äôt be, in theory), or not. We‚Äôll try to fix this soon.</em></p>
<h2 id="part-iii">Part III<a hidden class="anchor" aria-hidden="true" href="#part-iii">#</a></h2>
<p><img alt="Vector fonts" loading="lazy" src="https://lh3.googleusercontent.com/9hLe7o1xVss9McgIRoO9QCcPOCjmw1UrtaW2yxCzHHrc2rRJU3pLvOAE_wwqbyQy19W7hKbyxwHeRGFW6S9Y2mDeAvUjqxGVKOoKstwlSYZQUu8CZwFSwOPsadSiHeSeHaFxp8G59kA=-no"><img alt="Moon" loading="lazy" src="https://lh3.googleusercontent.com/i3b4XkNM_YgJOdkMtB-FUg1bsgnJIDe0gY0rD3pEPIdu_QhmHI-QgSR-9p0TFn3jbjWMqeEy2lOwiaXjKvqoM-8j_sqXCYScRfBe_aTfo2Khu1v5WgbqkVI7S9j0XjOHXytdIOEUQQI=-no"><img alt="Still there" loading="lazy" src="https://lh3.googleusercontent.com/NGYFNnYBO6G8Lg6QOfYERmV6WKaZ-VcwJafIuHMcV1bXkkGeBvJqoP4Pc5QnNWCF-Byi63_yxadzSmHywlW2oXk6c-_s6qBhjFN0vBbkBaZs6HhKhFDseyiQJiPg0IAi09Qcizg_E-g=-no"> <em>[Note: Originally, we wanted to add some 3d effects in Part III. But after doing some performance tests with basic 2D polygons, we decided it was not worth it. The PCjr was too slow for what we wanted to do. We reused part of that code for the Vector Fonts.]</em></p>
<h3 id="vector-fonts">Vector fonts<a hidden class="anchor" aria-hidden="true" href="#vector-fonts">#</a></h3>
<p>By <em>vector font</em> we mean a letter that is defined by one or more polygons. I‚Äôm using a primitive to draw a line called <code>Line08_Draw</code> ( <a href="https://www.abebooks.com/book-search/title/programmers-guide-video-systems/author/richard-wilton/">code based on Richard Wilton book</a>).</p>
<p>On top of that we implemented a <code>draw_poly</code> function. And each letter is defined by a list of polygons.</p>
<p>The benefits of vector fonts, it is to scale them up/down &amp; rotate them for <em>free</em>, without losing precision.</p>
<p>The fonts are defined using polar coordinates ( <code>radius</code> + <code>angle</code>); not the more common cartesian coordinates ( <code>x</code> + <code>y</code>). This is legacy code from my 2d-polygon experiment. Using polar coordinates + lookup table is a nice and fast way to rotate polygons. But in retrospective, kind of overkill for Part III.</p>
<h3 id="render-buffer">Render buffer<a hidden class="anchor" aria-hidden="true" href="#render-buffer">#</a></h3>
<p>Mode 160x100 @ 16 colors ( <a href="https://www.brutman.com/forums/viewtopic.php?f=6&amp;t=668&amp;start=10">Trixter‚Äôs variation</a>) is being used for the vector font part. And the bottom 40 rows are reserved for the fonts. That‚Äôs a total of 3200 bytes (160*40/2). We are using an additional 3200-bytes buffer (a render buffer) where the text is pre-rendered. Then the render buffer is copied row by row, one at the time, to the video buffer. The video buffer is scrolled up or down (depending on the effect). And that is basically it.</p>
<h2 id="easter-egg">Easter Egg<a hidden class="anchor" aria-hidden="true" href="#easter-egg">#</a></h2>
<p>[caption id=&quot;&quot; align=&ldquo;alignnone&rdquo; width=&ldquo;512&rdquo;]<img alt="Easter Egg" loading="lazy" src="https://lh3.googleusercontent.com/zQdb6LGUoqZPppQeiL0y99YER7aoGiy4Q_RWfhtoyMuxADTadncsruPckS3oVOmkAdhnwMcrfJDGzRTpRWiU6lrkvtDS0IvUpTnBPSNAgYKHsUT1crA7j-nciMm6VPQkEFMUBTuJAyI=-no"> Easter Egg[/caption]
The final part is pure PCjr BIOS code.</p>
<ul>
<li>Populate the keyboard buffer with ‚ÄúPVM RULEZ!‚Äù</li>
<li>Put sprite data in the correct place</li>
<li>Initialize some video variables</li>
<li>‚Ä¶and jump to the correct place in BIOS.</li>
</ul>
<p>The sprite data needs to be placed at <code>0060:0000</code>, the same space used for the demo, so extra careful was needed to not overwrite our own <em>init_easter_egg</em> routine.</p>
<h2 id="misc">Misc<a hidden class="anchor" aria-hidden="true" href="#misc">#</a></h2>
<p>All the ‚Äúofficial‚Äù PCjr video modes were used in this demo, without any
repetition.</p>
<ul>
<li>Boot loader: 40x25, 80x25 (when PCjr is not detected)</li>
<li>Part I: 160x200 @ 16, 320x200 @ 4</li>
<li>Part II: 320x200 @ 16</li>
<li>Part III: 160x100 @ 16, 640x200 @ 4, 640x200 @ 2</li>
</ul>
<h2 id="embarrassing-bug"><strong>Embarrassing bug</strong><a hidden class="anchor" aria-hidden="true" href="#embarrassing-bug">#</a></h2>
<p>The demo is all about the 64k-RAM PCjr. The embarrassing part is that some¬†graphics don‚Äôt look Ok with the 64k-RAM PCjr. The high-density video mode¬†(80x25 text, 320x200 @ 16 colors and 640x200 @ 4 colors) are disabled in the¬†64K-RAM PCjr for a good reason: the PCjr can‚Äôt display them, at least, in¬†theory.</p>
<p>Two months before the deadline, we did a test on a 64k-RAM PCjr, and the¬†320x200 @ 16 colors video mode looked correct‚Ä¶ only because we tested with¬†a single color graphic. We painted the screen with one color, and it looked¬†fine.</p>
<p>But one day before the deadline, while we were testing a release-candidate on¬†the 64k-RAM PCjr, we noticed that some graphics weren‚Äôt looking Ok. We¬†panicked. We couldn‚Äôt believe what were seeing. We tried to understand what was¬†happening, but we failed and couldn‚Äôt fix the bug.</p>
<p>[caption id=&quot;&quot; align=&ldquo;alignnone&rdquo; width=&ldquo;512&rdquo;]<img loading="lazy" src="https://lh3.googleusercontent.com/BbuNMeyPTVp4OrqNaLOomwVlUw6rLjHDSxzSTirFAfLsYmGa5MgUUPRvpq-EboKAQs1KSJHqsLRNxLQSCD7dPnjf9ATH4uYnoNFdgwAPiIeaIaBxydVHTRuhT3lrUlcnPpbnVApAD20=-no"> Looks OKish from far away&hellip;[/caption]</p>
<figure>
    <img loading="lazy" src="https://lh3.googleusercontent.com/PX80RCtJlleydn%5F12eINRx0hb33IhUfvNaFmjW-WbJm2c0qaBejXYtzmcpn4yc-z2pqn-o0KZPQl3qi8LIgiH1awNpt0-nRfk%5F1lcLVkla0AzF3rYdnSl%5FdRWg79McJsU4M2PFHEO4w=-no" width="512"/> 
</figure>

<p>So we shipped the demo with this embarrassing bug. A few days after the party,¬†and after discussing it <a href="https://www.brutman.com/forums/viewtopic.php?f=3&amp;t=758&amp;sid=2cf3911aaf269aa1588aa053886a2769#p5675">in the PCjr forum</a>, we realized that the 64k-RAM¬†PCjr has the following limitations:</p>
<p><em>The system board 64K RAM is mapped at the bottom of the 1Mb address space.¬†The system board 64Kb RAM is mapped to the next 64K bytes of address space if¬†the the 64Kb Memory and Display Expansion option is not installed.</em></p>
<p><em>When inserted, the memory expansion option uses the ODD memory space, while¬†the system memory space is decoded as the EVEN memory. Thus, when used as video¬†memory, the memory expansion option has the video attributes while the on-board¬†system memory has the video characters. This arrangement provides a higher¬†bandwidth of video characters.</em></p>
<p><em>In addition to the eight memory modules, the expansion card has logic to do¬†EVEN/ODD address decoding, video data multiplexing and Card Present wrap.</em></p>
<p>And that explains why the 640x200@4 graphic looked as a monochrome bitmap and¬†the 320x200@16 looked jagged. It is related how these 2 video modes are represented. (See ‚Äú <a href="https://archive.org/details/IBMPCJrTechnicalReference_201705/page/n1">PCjr Technical Reference</a>‚Äù Section 2‚Äì55 for further details).</p>
<p><img loading="lazy" src="https://lh3.googleusercontent.com/gAwOHkkjrfOGeoiCKItDsYUxj6LV_puAqNreLwDhPr_7LY-XCVxb9G8mnJTOmAsUY3N3XDOKIl8nooV1GGR1qCHI_r4KyLznjUvE6C7vblTRbX-GeYwOECdznilZcyShnMFUKOzUKWA=-no"></p>
<p>Monochrome when in 64K RAM only</p>
<p>We tried to disable the ‚Äúeven/odd‚Äù decoder by setting ‚ÄúMode Control 1‚Äù‚Äôs¬†High-Bandwidth register to 0. But that brings other issues. We still don‚Äôt know¬†whether or not it is feasible to display a high-density graphic in the 64K-RAM¬†PCjr. Although everything seems to indicate that it is not feasible.</p>
<p>The not-so-bad news is that the 128K-RAM PCjr (the most popular model), is as¬†slow as the 64k-RAM version but runs the demo correctly. No glitches in the¬†graphics.In fact, if we had targeted the 128k-RAM version, probably we could¬†have fit everything in a single executable + our boot loader.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>

<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 64K RAM Ought to be Enough: a demo for the PCjr on x"
            href="https://x.com/intent/tweet/?text=64K%20RAM%20Ought%20to%20be%20Enough%3a%20a%20demo%20for%20the%20PCjr&amp;url=http%3a%2f%2flocalhost%3a1313%2f2018%2f09%2f26%2f64k-ram-ought-to-be-enough-a-demo-for-the-pcjr%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 64K RAM Ought to be Enough: a demo for the PCjr on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2f2018%2f09%2f26%2f64k-ram-ought-to-be-enough-a-demo-for-the-pcjr%2f&amp;title=64K%20RAM%20Ought%20to%20be%20Enough%3a%20a%20demo%20for%20the%20PCjr&amp;summary=64K%20RAM%20Ought%20to%20be%20Enough%3a%20a%20demo%20for%20the%20PCjr&amp;source=http%3a%2f%2flocalhost%3a1313%2f2018%2f09%2f26%2f64k-ram-ought-to-be-enough-a-demo-for-the-pcjr%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 64K RAM Ought to be Enough: a demo for the PCjr on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2f2018%2f09%2f26%2f64k-ram-ought-to-be-enough-a-demo-for-the-pcjr%2f&title=64K%20RAM%20Ought%20to%20be%20Enough%3a%20a%20demo%20for%20the%20PCjr">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 64K RAM Ought to be Enough: a demo for the PCjr on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2f2018%2f09%2f26%2f64k-ram-ought-to-be-enough-a-demo-for-the-pcjr%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 64K RAM Ought to be Enough: a demo for the PCjr on whatsapp"
            href="https://api.whatsapp.com/send?text=64K%20RAM%20Ought%20to%20be%20Enough%3a%20a%20demo%20for%20the%20PCjr%20-%20http%3a%2f%2flocalhost%3a1313%2f2018%2f09%2f26%2f64k-ram-ought-to-be-enough-a-demo-for-the-pcjr%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 64K RAM Ought to be Enough: a demo for the PCjr on telegram"
            href="https://telegram.me/share/url?text=64K%20RAM%20Ought%20to%20be%20Enough%3a%20a%20demo%20for%20the%20PCjr&amp;url=http%3a%2f%2flocalhost%3a1313%2f2018%2f09%2f26%2f64k-ram-ought-to-be-enough-a-demo-for-the-pcjr%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 64K RAM Ought to be Enough: a demo for the PCjr on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=64K%20RAM%20Ought%20to%20be%20Enough%3a%20a%20demo%20for%20the%20PCjr&u=http%3a%2f%2flocalhost%3a1313%2f2018%2f09%2f26%2f64k-ram-ought-to-be-enough-a-demo-for-the-pcjr%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
